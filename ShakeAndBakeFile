RUN mkdir -p output/releases &&
  mkdir -p output/iso-src

# --> not working -o images/cf/bosh-operations/use-warden-cpi-v39.yml \
RUN bosh int ../bosh-deployment/bosh.yml \
  -o ../bosh-deployment/bosh-lite.yml \
  -o ../bosh-deployment/bosh-lite-runc.yml \
  -o ../bosh-deployment/bosh-lite-grootfs.yml \
  -o ../bosh-deployment/warden/cpi.yml \
  -o ../bosh-deployment/warden/cpi-grootfs.yml \
  -o ../bosh-deployment/jumpbox-user.yml \
  -o images/cf/bosh-operations/disable-app-armor.yml \
  -o images/cf/bosh-operations/remove-ports.yml \
  -o images/cf/bosh-operations/use-stemcell-3586.16.yml \
  -v director_name="warden" \
  -v internal_cidr=10.245.0.0/24 \
  -v internal_gw=10.245.0.1 \
  -v internal_ip=10.245.0.2 \
  -v garden_host=10.0.0.10 \
  > output/bosh.yml

RUN bosh int ../bosh-deployment/runtime-configs/dns.yml \
  -o images/cf/bosh-operations/add-host-pcfdev-dns-record.yml \
  > output/dns-runtime-config.yml

RUN bosh int ../cf-deployment/iaas-support/bosh-lite/cloud-config.yml \
  -o images/cf/cf-operations/set-cloud-config-subnet.yml \
  > output/cloud-config.yml

RUN bosh int ../cf-deployment/cf-deployment.yml \
  -o ../cf-deployment/operations/use-compiled-releases.yml \
  -o ../cf-deployment/operations/experimental/skip-consul-cell-registrations.yml \
  -o ../cf-deployment/operations/experimental/skip-consul-locks.yml \
  -o ../cf-deployment/operations/experimental/use-bosh-dns-for-containers.yml \
  -o ../cf-deployment/operations/experimental/disable-consul.yml \
  -o ../cf-deployment/operations/bosh-lite.yml \
  -o ../cf-deployment/operations/experimental/disable-consul-bosh-lite.yml \
  -o images/cf/cf-operations/allow-local-docker-registry.yml \
  -o images/cf/cf-operations/garden-disable-app-armour.yml \
  -o images/cf/cf-operations/collocate-tcp-router.yml \
  -o images/cf/cf-operations/set-cfdev-subnet.yml \
  -o images/cf/cf-operations/lower-memory.yml \
  -o images/cf/cf-operations/remove-smoke-test.yml \
  -o images/cf/cf-operations/low-tcp-ports.yml \
  -v cf_admin_password=admin \
  -v uaa_admin_client_secret=admin-client-secret \
  > output/cf.yml

RUN bosh int ../cf-mysql-deployment/cf-mysql-deployment.yml \
  -o ../cf-mysql-deployment/operations/add-broker.yml \
  -o ../cf-mysql-deployment/operations/register-proxy-route.yml \
  -o ../cf-mysql-deployment/operations/no-arbitrator.yml \
  -o images/cf/mysql-operations//single-instances.yml \
  -o images/cf/mysql-operations/use-stemcell-3586.16.yml \
  -v cf_mysql_external_host=p-mysql.v3.pcfdev.io \
  -v cf_mysql_host=v3.pcfdev.io \
  -v cf_admin_password=admin \
  -v cf_api_url=https://api.v3.pcfdev.io \
  -v cf_skip_ssl_validation=true \
  -v proxy_vm_extension=mysql-proxy-lb \
  > output/mysql.yml

#TODO generate tar files then put in iso directory
RUN docker build -t pivotal/cf images/cf && \
  cid=$(docker run -d pivotal/cf sleep infinity) && \
  docker export "$cid" > output/iso-src/workspace.tar && \
  docker kill "$cid" && \
  docker rm "$cid" && \
  mkisofs -V cf-deps -R -o output/cf-deps.iso output/iso-src

RUN linuxkit pkg build -hash dev linuxkit/pkg/bosh-lite-routing && \
  linuxkit pkg build -hash dev linuxkit/pkg/expose-multiple-ports && \
  linuxkit pkg build -hash dev linuxkit/pkg/garden-runc && \
  linuxkit pkg build -hash dev linuxkit/pkg/openssl && \
  linuxkit build \
   -disable-content-trust \
   -name cfdev \
   -format iso-efi \
   -dir output \
   linuxkit/base.yml \
   linuxkit/garden.yml \

RUN ./src/code.cloudfoundry.org/cfdev/generate-plugin.sh